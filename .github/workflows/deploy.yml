name: Deploy to Production

on:
    workflow_dispatch:
        inputs:
            reason:
                description: "Reason for production deployment"
                required: false
                type: string
    push:
        branches: [main]

jobs:
    check-deploy:
        runs-on: ubuntu-latest
        outputs:
            skip: ${{ steps.skip_check.outputs.skip }}
        steps:
            - name: Check for --skip-deploy flag
              id: skip_check
              run: |
                  echo "Commit message:"
                  echo "$GITHUB_EVENT_HEAD_COMMIT_MESSAGE"
                  if echo "$GITHUB_EVENT_HEAD_COMMIT_MESSAGE" | grep -q -- "--skip-deploy"; then
                      echo "skip=true" >> "$GITHUB_OUTPUT"
                  else
                      echo "skip=false" >> "$GITHUB_OUTPUT"
                  fi
              env:
                  GITHUB_EVENT_HEAD_COMMIT_MESSAGE: ${{ github.event.head_commit.message }}

    deploy:
        needs: check-deploy
        if: needs.check-deploy.outputs.skip == 'false'
        runs-on: ubuntu-latest

        steps:
            - name: Send Deploy Start Notification
              if: always()
              continue-on-error: true
              uses: sarisia/actions-status-discord@v1
              with:
                  webhook: ${{ secrets.DISCORD_WEBHOOK }}
                  noprefix: true
                  title: "üöÄ Deployment Started"
                  description: |
                      Starting deployment to production environment...
                      - Reason: `${{ github.event.inputs.reason || github.event.head_commit.message || 'Manual deploy' }}`
                  color: 0x008cff

            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 10.17.0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Build project
              run: pnpm build

            - name: Create deployment package
              run: |
                  mkdir -p deploy-package
                  cp -r .output deploy-package/
                  cp -r public deploy-package/ || true
                  cp package.json deploy-package/
                  cp pnpm-lock.yaml deploy-package/
                  cp ecosystem.config.cjs deploy-package/ || true

            - name: Verify Dependencies
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.SERVER_HOST }}
                  username: ${{ secrets.SERVER_USER }}
                  key: ${{ secrets.SERVER_SSH_KEY }}
                  script: |
                      echo "Checking dependencies..."
                      echo "========================"

                      # Node.js check and install
                      if ! command -v node &> /dev/null; then
                          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash - 
                          sudo apt-get install -y nodejs
                      fi

                      # Check pnpm
                      if ! command -v pnpm &> /dev/null; then
                          echo "Installing pnpm..."
                          npm install -g pnpm
                      fi

                      # PM2 check
                      if ! command -v pm2 &> /dev/null; then
                          npm install -g pm2
                      fi

            - name: List Current PM2 Processes
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.SERVER_HOST }}
                  username: ${{ secrets.SERVER_USER }}
                  key: ${{ secrets.SERVER_SSH_KEY }}
                  script: |
                      echo "List of current pm2 processes:"
                      echo "==============================="
                      pm2 ls

            - name: Deploy to VPS
              uses: appleboy/scp-action@v0.1.7
              with:
                  host: ${{ secrets.SERVER_HOST }}
                  username: ${{ secrets.SERVER_USER }}
                  key: ${{ secrets.SERVER_SSH_KEY }}
                  source: "deploy-package/*"
                  target: "~/projects/portfolio"
                  strip_components: 1

            - name: Install dependencies and restart service
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.SERVER_HOST }}
                  username: ${{ secrets.SERVER_USER }}
                  key: ${{ secrets.SERVER_SSH_KEY }}
                  script: |
                      # Ensure pnpm is on PATH
                      export PATH="$HOME/.local/share/pnpm:$PATH"

                      cd ~/projects/portfolio || { echo "Directory not found"; exit 1; }

                      echo "Installing production dependencies..."
                      pnpm install --frozen-lockfile --prod

                      # Reload service
                      echo "Reloading service..."
                      pm2 reload portfolio || pm2 start ecosystem.config.cjs

                      # Ensure it's running
                      sleep 5
                      pm2 ls

                      # Show final status
                      echo "Production deployment completed!"
                      exit 0

            - name: Cleanup
              if: always()
              run: rm -rf deploy-package

    notify:
        needs: [check-deploy, deploy]
        runs-on: ubuntu-latest
        if: always()
        steps:
            - name: Send Discord Notification
              continue-on-error: true
              uses: sarisia/actions-status-discord@v1
              with:
                  webhook: ${{ secrets.DISCORD_WEBHOOK }}
                  noprefix: true
                  title: >-
                      ${{ needs.check-deploy.outputs.skip == 'true' && '‚è≠Ô∏è Deployment Skipped' ||
                          (needs.deploy.result == 'success' && '‚úÖ Deployment Successful') ||
                          '‚ùå Deployment Failed' }}
                  description: >-
                      ${{ needs.check-deploy.outputs.skip == 'true'
                          && 'Deployment was skipped due to `--skip-deploy` flag in commit message.'
                          || format('- Status: `{0}`\n - Reason: `{1}`',
                              needs.deploy.result,
                              github.event.inputs.reason || github.event.head_commit.message || 'Automated deploy') }}
                  color: >-
                      ${{ needs.check-deploy.outputs.skip == 'true' && '0xffff00' ||
                          (needs.deploy.result == 'success' && '0x1df27d') || '0xff5050' }}
                  content: >-
                      ${{ needs.deploy.result != 'success' && needs.check-deploy.outputs.skip != 'true'
                          && '‚ö†Ô∏è deploy failed!' || '' }}
